-- Auto-Process Camera Folder
-- Drag a folder onto this app to:
-- 1. Add GPS info from GPX file
-- 2. Rename files with date and time
-- 3. Convert .mov files to .mp4

on open droppedFolders
    repeat with aFolder in droppedFolders
        set folderPath to POSIX path of aFolder
        
        -- Look for a GPX file in the folder
        set gpxFileList to do shell script "find " & quoted form of folderPath & " -maxdepth 1 -name '*.gpx'"
        if gpxFileList is not "" then
            set gpxFile to gpxFileList
        else
            set gpxFile to ""
        end if
        
        -- Add GPS info to images using exiftool (requires exiftool installed)
        if gpxFile is not "" then
            do shell script "exiftool -geotag " & quoted form of gpxFile & " " & quoted form of folderPath & "/*.jpg"
        end if
        
        -- Rename files with date and time from metadata
        do shell script "exiftool '-FileName<DateTimeOriginal' -d '%Y%m%d_%H%M%S%%-c.%%e' " & quoted form of folderPath
        
        -- Convert .mov to .mp4 using ffmpeg (requires ffmpeg installed)
        set movFiles to do shell script "find " & quoted form of folderPath & " -type f -name '*.mov'"
        if movFiles is not "" then
            set AppleScript's text item delimiters to linefeed
            set movList to text items of movFiles
            repeat with movFile in movList
                set mp4File to (movFile & ".mp4")
                do shell script "ffmpeg -i " & quoted form of movFile & " -c:v libx264 -preset fast -crf 23 -c:a aac -b:a 128k " & quoted form of mp4File
            end repeat
        end if
    end repeat
end open
